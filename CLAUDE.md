# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is a T3 Turbo monorepo for a cross-platform todo list application with web (Next.js) and mobile (Expo) clients sharing a common tRPC API backend. The stack uses:

- **Turborepo** for monorepo management
- **Next.js 15** with React 19 for web
- **Expo** with React Native for mobile
- **tRPC v11** for type-safe API layer
- **Drizzle ORM** with PostgreSQL (Neon/Supabase)
- **Better Auth** for authentication
- **Tailwind CSS v4** for styling
- **shadcn/ui** for web UI components

## Development Commands

### Initial Setup

```bash
# Install dependencies
pnpm i

# Generate Better Auth schema (REQUIRED before first run)
pnpm auth:generate

# Push database schema
pnpm db:push
```

### Development

```bash
# Run all apps in watch mode
pnpm dev

# Run only Next.js app
pnpm dev:next

# Run database studio
pnpm db:studio
```

### Database Operations

```bash
# Push schema changes to database
pnpm db:push

# Open Drizzle Studio
pnpm db:studio

# Run from packages/db directory for direct access
cd packages/db
pnpm push
pnpm studio
```

### Code Quality

```bash
# Lint all packages
pnpm lint

# Lint and auto-fix
pnpm lint:fix

# Format check
pnpm format

# Format and fix
pnpm format:fix

# Type check all packages
pnpm typecheck

# Validate workspace dependencies
pnpm lint:ws
```

### UI Components (Web)

```bash
# Add new shadcn/ui component (runs from packages/ui)
pnpm ui-add

# This runs: pnpm dlx shadcn@latest add
# Components are added to packages/ui/src/
```

**Important**: Always use `pnpm ui-add` when adding new UI components for the web app. Do NOT manually create UI components - use the shadcn CLI which properly sets up Radix UI primitives with correct imports.

After adding components via shadcn, you may need to fix imports:
- Change `lucide-react` imports to `@radix-ui/react-icons`
- Change `src/lib/utils` imports to `@acme/ui`

### Mobile Development

```bash
# iOS
pnpm ios

# Android
pnpm android
```

## Architecture

### Monorepo Structure

```
apps/
  ├── expo/          # React Native mobile app
  └── nextjs/        # Next.js web app
packages/
  ├── api/           # tRPC router definitions
  ├── auth/          # Better Auth configuration
  ├── db/            # Drizzle schema and client
  └── ui/            # Shared UI components (shadcn/ui)
tooling/
  ├── eslint/        # ESLint configurations
  ├── prettier/      # Prettier config
  ├── tailwind/      # Tailwind theme
  └── typescript/    # TypeScript configs
```

### Package Dependencies

- **Next.js app** depends on: `@acme/api`, `@acme/auth`, `@acme/db`, `@acme/ui`
- **Expo app** depends on: `@acme/api` (dev only for types), `@acme/auth`
- **API package** depends on: `@acme/auth`, `@acme/db`
- **Auth package** depends on: `@acme/db`

### Database Schema Pattern

Database schemas follow these conventions:

1. **Main schema**: `packages/db/src/schema.ts` - Application tables
2. **Auth schema**: `packages/db/src/auth-schema.ts` - Generated by Better Auth CLI
3. **Export pattern**: Both schemas exported from `packages/db/src/index.ts`

**Important**: The auth schema is auto-generated. To modify auth tables:
1. Edit `packages/auth/script/auth-cli.ts` (Better Auth config)
2. Run `pnpm auth:generate`
3. Run `pnpm db:push` to apply changes

Database naming follows `snake_case` convention (configured in `drizzle.config.ts`).

### tRPC API Pattern

API routes are defined in `packages/api/src/router/`:

1. Create router file (e.g., `task.ts`)
2. Define procedures using `publicProcedure` or `protectedProcedure`
3. Register in `packages/api/src/root.ts`

**User-scoped queries**: Always filter by `ctx.session.user.id` in `protectedProcedure`:

```typescript
protectedProcedure.query(({ ctx }) => {
  return ctx.db.query.Task.findMany({
    where: eq(Task.userId, ctx.session.user.id),
  });
});
```

### Authentication Flow

Better Auth configuration is split:

- **Runtime config**: `packages/auth/src/index.ts` - Used by Next.js app
- **CLI config**: `packages/auth/script/auth-cli.ts` - Used only for schema generation

The CLI config is isolated in `script/` directory to prevent accidental imports.

Current setup uses Discord OAuth. To add providers, update both configs.

### Cross-Platform Considerations

**Web (Next.js)**:
- Uses `@acme/ui` components (shadcn/ui with Radix UI)
- Server components by default
- Client components marked with `"use client"`

**Mobile (Expo)**:
- Cannot use `@acme/ui` components (web-only)
- Uses React Native components with NativeWind
- Custom checkbox implementation (not Radix UI)

**Shared**:
- tRPC client setup differs (React Query configuration)
- Auth uses Better Auth Expo adapter for mobile
- Both use TanStack Query for state management

## Common Patterns

### Adding a New Feature

1. **Database**: Add table to `packages/db/src/schema.ts` with Zod schemas
2. **API**: Create router in `packages/api/src/router/` and register in `root.ts`
3. **Web UI**: Create components in `apps/nextjs/src/app/_components/`
4. **Mobile UI**: Create components in `apps/expo/src/app/`
5. **Push changes**: Run `pnpm db:push` to update database

### Creating Database Tables

Tables should include:
- UUID primary key with `defaultRandom()`
- User foreign key for user-scoped data: `references(() => user.id, { onDelete: "cascade" })`
- Timestamps: `createdAt`, `updatedAt` (with `$onUpdateFn`)
- Soft deletes: `deletedAt` timestamp (optional)
- Indexes for common query patterns

### Query Invalidation Pattern

After mutations, invalidate queries for immediate UI updates:

```typescript
// Web (Next.js)
await queryClient.invalidateQueries(trpc.task.pathFilter());

// Mobile (Expo)
await queryClient.invalidateQueries(trpc.task.all.queryFilter());
```

### Form Handling

**Web**: TanStack Form with Zod validation
**Mobile**: React state with manual validation

Both use the same Zod schemas from `@acme/db/schema`.

## Environment Variables

Required in `.env` at repository root:

```bash
POSTGRES_URL=           # Neon/Supabase connection string
AUTH_SECRET=            # Random secret for Better Auth
AUTH_DISCORD_ID=        # Discord OAuth client ID
AUTH_DISCORD_SECRET=    # Discord OAuth client secret
AUTH_REDIRECT_PROXY_URL= # Auth proxy URL (for Expo OAuth)
PORT=3000               # Optional: Next.js port
```

## Troubleshooting

### Database Issues

If migrations fail with interactive task error, run directly:
```bash
cd packages/db && pnpm push
```

### Auth Schema Not Found

Generate the auth schema:
```bash
pnpm auth:generate
```

### Module Resolution Issues

Ensure all internal packages are built:
```bash
pnpm build
```

### Expo OAuth Not Working

1. Deploy Next.js app to get stable URL
2. Set `AUTH_REDIRECT_PROXY_URL` to deployed URL
3. Add auth proxy plugin to Better Auth config (already included)

## Code Style

- **TypeScript**: Strict mode enabled
- **Imports**: Use `@acme/*` package names, not relative paths across packages
- **Components**: Functional components with TypeScript
- **Naming**: camelCase for variables/functions, PascalCase for components
- **Database**: snake_case for table/column names (auto-converted by Drizzle)

## Design System

**IMPORTANT**: When creating or modifying UI components, ALWAYS reference `DESIGN_SYSTEM.md` for:

- **Colors**: Use the Emerald Green theme palette (see Color System section)
  - Primary: `#50C878` (emerald green)
  - Background: `#0A1A1A` (deep) / `#102A2A` (surface)
  - Text: `#DCE4E4` (primary) / `#8FA8A8` (muted)
  - Borders: `#164B49` (default) / `#21716C` (focused)
- **Typography**: Use Geist Sans font with documented type scale
- **Spacing**: Follow 4px base grid (spacing scale in `DESIGN_SYSTEM.md`)
- **Components**: Reference component patterns for Task Cards, Pills, FAB, Inputs, Buttons
- **Visual Effects**: Apply glassmorphism, glow effects, and shadows as documented
- **Accessibility**: Meet contrast ratios (7:1 for text, 4.5:1 for UI elements)

### UI Component Creation Checklist

Before creating any UI component, review these sections in `DESIGN_SYSTEM.md`:

1. **Color System** → Use semantic colors from Emerald Green theme
2. **Typography** → Apply correct font sizes and weights from type scale
3. **Spacing & Layout** → Use spacing scale (xs/sm/md/lg/xl)
4. **Components** → Follow established patterns for similar elements
5. **Visual Effects** → Apply appropriate shadows, border radius, and glow effects
6. **Animations** → Use documented timing functions and durations
7. **Accessibility** → Ensure proper touch targets (44-48px) and ARIA labels
8. **Platform Considerations** → Web vs Mobile implementation differences

### Design Tokens Quick Reference

```typescript
// Import from design system
Colors: See "Design Tokens Reference" section
Spacing: 4px base (xs: 4px, sm: 8px, md: 16px, lg: 24px, xl: 32px)
Radius: sm: 8px, md: 10px, lg: 12px, xl: 16px, full: 9999px
Shadows: '2xs' through '2xl' plus 'glow' and 'glowHover'
```

### Component-Specific Guidelines

**Task Cards**:
- Background: `#102A2A` (surface)
- Padding: 16px (p-4)
- Border radius: 12px (rounded-lg)
- Shadow: shadow-lg
- Text: `#DCE4E4` primary, `#8FA8A8` muted

**Category Pills**:
- Active: `#50C878` border, emerald glow, 20% opacity background
- Inactive: `#164B49` border, transparent background
- Border radius: full (rounded-full)
- Padding: px-6 py-2

**Buttons**:
- Primary: `#50C878` background, `#0A1A1A` text
- Hover: `#66D99A` (primary-bright)
- Active: `#388E3C` (primary-dim)
- Border radius: 8px (rounded-md)

**Inputs**:
- Background: `#102A2A`
- Border: `#164B49` default, `#21716C` focused
- Text: `#DCE4E4`, placeholder: `#8FA8A8`
- Border radius: 8px (rounded-md)

**ALWAYS** consult `DESIGN_SYSTEM.md` for complete specifications and visual examples.
